---
title: "W271 Lab 2"
author: "Tiffany Jaya, Joanna Huang, Shan He, Robert Deng"
output: 
  pdf_document:
  toc: true
  number_sections: true
fontsize: 11pt
geometry: margin=1in
---

```{r message=FALSE}
# add packages
library(dplyr)
library(knitr)
library(MASS)
library(nnet)
library(Hmisc)
library(car)
# prevent source code from running off the page
opts_chunk$set(tidy.opts=list(width.cutoff=70), tidy=TRUE)
# remove all objects from current workspace
rm(list = ls())
# set seed number to reproduce results
set.seed(1)
# load data
d <- read.csv("./dataset/cereal_dillons.csv", header=TRUE, sep=",")
```

# Introduction

We are under the impression that supermarkets place cereals strategically on shelves in order to increase sales. For this reason, a random sample of size 10 was taken from each of the four shelves at a Dillons grocery store in Manhattan, KS in order to answer our question: Does the cereal's nutritional composition have a significant effect on its shelving placement? 

TODO: methodology being employed, highlight the results

# EDA

In order for us to address this question, we first explored the dataset. The dataset contains 40 observations with 7 numerical attributes and no missing values:

- ID: Unique identifier for each cereal
- Shelf: Shelf number, which is numbered from the bottom (1) to the top (4)
- Cereal: Cereal product name with 38 distinct names
- size_g: Serving size with a range of 27-60 grams
- sugar_g: Sugar per serving with a range of 0-20 grams
- fat_g: Fat per serving with a range of 0-5 grams
- sodium_mg: Sodium per serving with a range of 0-330 milligrams

```{r}
# structure of data
str(d)
# summary of data
kable(summary(d[, 4:7]))
# list row with missing values
d[!complete.cases(d),]
```

## Question A: Reformat the data

**The explanatory variables need to be re-formatted before proceeding further. First, divide each explanatory variable by its serving size to account for the different serving sizes among the cereals. Second, re-scale each variable to be
Symptoms Seizures Cardiac deficiency within 0 and 1.**

```{r}
# 1. adjust for different serving sizes 
adj.d <- data.frame(shelf = d$Shelf, 
                    sugar = d$sugar_g/d$size_g,
                    fat = d$fat_g/d$size_g, 
                    sodium = (d$sodium_mg/1000)/d$size_g)
# 2. normalize data to be within 0 and 1
normalize <- function(x) { (x-min(x))/(max(x)-min(x)) }
norm.d <- data.frame(shelf = adj.d$shelf, 
                     sugar = normalize(adj.d$sugar),
                     fat = normalize(adj.d$fat),
                     sodium = normalize(adj.d$sodium))
```

## Univariate analysis

Now that we have adjusted the data to account for the different serving size and normalized to be within 0 and 1, we can begin analyzing the explanatory variables of interest, the cereal nutrition's composition: sugar per serving, fat per serving, and sodium per serving.

```{r fig.show='hold', fig.align='center', out.width='49%', results='hide'}
# explanatory variable: sugar
plot(density(d$sugar_g), col = "orange", lwd = 2, ylim = c(0, 0.15), main = "Density plot of sugar per serving")
lapply(seq(1, 4), function(shelf) lines(density(d[which(d$Shelf == shelf),]$sugar_g), col = shelf, lty = shelf))
rug(d$sugar_g)
legend("topleft", cex = 0.8, inset = .05, title = "Shelf Number", 
       legend = seq(1, 4), col = seq(1, 4), lty = seq(1, 4))

# explanatory variable: fat
plot(density(d$fat_g), col = "orange", lwd = 2, ylim = c(0, 1), main = "Density plot of fat per serving")
lapply(seq(1, 4), function(shelf) lines(density(d[which(d$Shelf == shelf),]$fat_g), col = shelf, lty = shelf))
rug(d$fat_g)
legend("topleft", cex = 0.8, inset = .05, title = "Shelf Number", 
       legend = seq(1, 4), col = seq(1, 4), lty = seq(1, 4))

# explanatory variable: sodium
plot(density(d$sodium_mg), col = "orange", lwd = 2, ylim = c(0, 0.015), main = "Density plot of sodium per serving")
lapply(seq(1, 4), function(shelf) lines(density(d[which(d$Shelf == shelf),]$sodium_mg), col = shelf, lty = shelf))
rug(d$sodium_mg)
legend("topleft", cex = 0.8, inset = .05, title = "Shelf Number", 
       legend = seq(1, 4), col = seq(1, 4), lty = seq(1, 4))
```

The orange density plot in each graph signifies the density plot for all shelves. As can be seen from the graph, the distribution of sugar per serving appears to be bimodal with the main peak having a wider spread than the smaller one. This is in part due to the second shelf having cereals with higher sugar content compared to those on the other shelves. Also, it is possible that within one shelf, cereal types change from one end of the shelf to the other, attributing to the bimodal shape. For example, cereals with higher sugar, fat, and sodium contents are more popular amongst children while adults might prefer a healthier alternative. It comes to no surprise that the second shelf also has a bimodal shape with cereals having higher fat and sodium content than those placed on the other shelves. In contrast, the third shelf seems to carry healthier alternative cereals with higher fat and lower sugar and sodium level. The density plot of fat per serving and sodium per serving, although appearing bimodal in shape, are not as distinct. The distribution of fat per serving is more positively skewed with few cereals having higher fat content overall while the distribution of sodium per serving is more negatively skewed with few cereals having less sodium content overall.

## Question B: Bivariate analysis

**Construct side-by-side box plots with dot plots overlaid for each of the explanatory variables.**

```{r fig.show='hold', fig.align='center', out.width='49%'}
# explanatory variable: sugar
boxplot(formula = sugar ~ shelf, data = norm.d, ylab = "Sugar", xlab = "Shelf", pars = list(outpch=NA))
stripchart(x = norm.d$sugar ~ norm.d$shelf, lwd = 2, col = "red", method = "jitter", vertical = TRUE, pch = 1, add = TRUE)

# explanatory variable: fat
boxplot(formula = fat ~ shelf, data = norm.d, ylab = "Fat", xlab = "Shelf", pars = list(outpch=NA))
stripchart(x = norm.d$fat ~ norm.d$shelf, lwd = 2, col = "red", method = "jitter", vertical = TRUE, pch = 1, add = TRUE)

# explanatory variable: sodium
boxplot(formula = sodium ~ shelf, data = norm.d, ylab = "Sodium", xlab = "Shelf", pars = list(outpch=NA))
stripchart(x = norm.d$sodium ~ norm.d$shelf, lwd = 2, col = "red", method = "jitter", vertical = TRUE, pch = 1, add = TRUE)
```

Although there are few outliers in the second shelf in terms of fat per serving, it does not appear to be outside of the realm of possibility if compared to the cereals in the first and third shelves. 

**Also, construct a parallel coordinates plot for the explanatory variables and the shelf number. Discuss if possible content differences exist among the shelves.**

```{r}
parcoord(x = norm.d, col = norm.d$shelf, lty = norm.d$shelf)  
legend("bottomleft", cex = 0.8, inset = .05, title = "Shelf Number",  bg = "white",
       legend = seq(1, 4), col = seq(1, 4), lty = seq(1, 4))
```

From this parallel coordinates plot, we see that:

1. Shelf 1 generally has higher sodium levels.
2. Shelf 2 generally has higher sugar levels.
3. Most cereals overlap in sugar and sodium levels but range in fat levels.

```{r}
# print out the mean and standard deviation 
norm.d %>% 
  group_by(shelf) %>% 
  summarise(mean.sugar=mean(sugar), sd.sugar=sd(sugar), 
            mean.fat=mean(fat), sd.fat=sd(fat),
            mean.sodium=mean(sodium), sd.sodium=sd(sodium))
```

What we noticed is similar to what we have noticed in our univariate analysis. The second shelf has higher sugar, fat, and sodium per serving in general. In addition, the first shelf has higher sodium levels as well as broader range in terms of sugar and fat content similar to the third shelf. 

# Question C: Ordinality of shelves
 
**The response has values of 1, 2, 3, and 4. Under what setting would it be desirable to take into account ordinality. Do you think this occurs here?**

Cereal manufacturers are willing to pay supermarkets more if their product was strategically placed on shelves where it can increase sales. Under this condition, it would be desirable to take ordinality into account. Based on past studies on store design and visual merchandising, retailers divide vertical shelves into 4 zones: 1) Stretch Level 2) Eye Level 3) Touch Level 4) Stoop Level. Eye Level and Touch Level are the most profitable with adults and children respectively given what’s easily seen and obtainable. Furthermore, since it takes a little less physical effort to tip toe for the Stretch Level than crouch down for the Stoop Level, we will assume the former is slightly more profitable as well. Based on this reasoning, we will rank the importance of the shelves as follows: 3 > 2 > 4 > 1. 

```{r}
# apply ordinality
norm.d$shelfF0 <- factor(norm.d$shelf, levels=c(3,2,4,1), ordered=TRUE)
levels(norm.d$shelfF0)
```

# Question D: Modeling

Since there are 4 shelf categories that a cereal box can be placed on, we will be using a multinomial regression model. Our goal is to model how the nutritional content affects a cereal’s corresponding probabilities in each shelf category.

Multinomial logistic regression does not assume normality, linearity, or homoscedasticity. However, it does assume independence among the dependent variable choices meaning that the membership in one category is not related to membership in another category. As of right now, we can assume that independence is met since the nutritional content of cereal A, for example, does not affect the nutritional content of cereal B and therefore its product placement on the shelf. Additionally, multinomial logistic regression assumes no complete separation.

**Estimate a multinomial regression model with linear forms of the sugar, fat, and sodium variables. Perform LRTs to examine the importance of each explanatory variable.**

```{r}
# set shelf 2 as the reference point
norm.d$shelf <- factor(norm.d$shelf)
norm.d$shelf <- relevel(norm.d$shelf, ref="2")
# estimate multinomial regression model 
m <- multinom(formula = shelf ~ sugar + fat + sodium, data = norm.d)
summary(m)
# perform LRT to examine importance of each variable
Anova(m)
```

From the coefficients table in the output, we obtain the estimated model as: 

$$\begin{aligned}
log(\frac{\hat{\pi}_{\text{shelf} = 1}}{\hat{\pi}_{\text{shelf} = 2}}) = -6.90 - 2.69(\text{sugar}) - 4.06(\text{fat}) + 17.49(\text{sodium}) + \varepsilon
\end{aligned}$$

* A one-unit increase in the variable sugar is associated with the decrease in the log odds of being in shelf 1 versus shelf 2 in the amount of 2.69. In other words, if the variable sugar increases by one unit, the chances of being placed in shelf 2 is higher than being in shelf 1.
* A one-unit increase in the variable fat is associated with the decrease in the log odds of being in shelf 1 versus shelf 2 in the amount of 4.06. In other words, if the variable fat increases by one unit, the chances of being placed in shelf 2 is higher than being in shelf 1. 
* A one-unit increase in the variable sodium is associated with the increase in the log odds of being in shelf 1 versus shelf 2 in the amount of 17.49. In other words, if the variable sodium increases by one unit, the chances of being placed in shelf 1 is higher than being in shelf 2.

$$\begin{aligned}
log(\frac{\hat{\pi}_{\text{shelf} = 3}}{\hat{\pi}_{\text{shelf} = 2}}) = 14.78 - 14.91(\text{sugar}) - 4.62(\text{fat}) - 7.49(\text{sodium}) + \varepsilon
\end{aligned}$$

* A one-unit increase in the variable sugar is associated with the decrease in the log odds of being in shelf 3 versus shelf 2 in the amount of 14.91. In other words, if the variable sugar increases by one unit, the chances of being placed in shelf 2 is higher than being in shelf 3.
* A one-unit increase in the variable fat is associated with the decrease in the log odds of being in shelf 3 versus shelf 2 in the amount of 4.62. In other words, if the variable fat increases by one unit, the chances of being placed in shelf 2 is higher than being in shelf 3. 
* A one-unit increase in the variable sodium is associated with the decrease in the log odds of being in shelf 3 versus shelf 2 in the amount of 7.49. In other words, if the variable sodium increases by one unit, the chances of being placed in shelf 2 is higher than being in shelf 3.

$$\begin{aligned}
log(\frac{\hat{\pi}_{\text{shelf} = 4}}{\hat{\pi}_{\text{shelf} = 2}}) = 14.39 - 14.09(\text{sugar}) - 4.93(\text{fat}) - 7.19(\text{sodium}) + \varepsilon
\end{aligned}$$

* A one-unit increase in the variable sugar is associated with the decrease in the log odds of being in shelf 4 versus shelf 2 in the amount of 14.09. In other words, if the variable sugar increases by one unit, the chances of being placed in shelf 2 is higher than being in shelf 4.
* A one-unit increase in the variable fat is associated with the decrease in the log odds of being in shelf 4 versus shelf 2 in the amount of 4.93. In other words, if the variable fat increases by one unit, the chances of being placed in shelf 2 is higher than being in shelf 4. 
* A one-unit increase in the variable sodium is associated with the decrease in the log odds of being in shelf 4 versus shelf 2 in the amount of 7.19. In other words, if the variable sodium increases by one unit, the chances of being placed in shelf 2 is higher than being in shelf 4.

Based on the likelihood ratio test, sugar and sodium are important explanatory variables in determining where the cereal will be placed on the shelf. On the other hand, there is not sufficient evidence that the fat variable has an effect on the shelf placement.

# Question E: 

**Show that there are no significant interactions among the explanatory variables (including an interaction among all three variables).**

TODO (Tiffany): I haven't double checked this yet

```{r}
#cor(cereal2[,c("sugar", "fat", "sodium")])
library(psych)
pairs.panels(cereal2[,c("sugar", "fat", "sodium")])
```

Looking at the correlation between the three explanatory variables, there does not appear to be any strong relationships as the correlation coefficients are all less than 0.5 in magnitude.

To look at whether we need interactions within our model, we can create a saturated model and run an Anova test to see if any interactions have significance.

```{r}
m0 <- multinom(formula=Shelf~1, data=cereal2)
m2 <- multinom(formula = Shelf ~ sugar*fat*sodium, data=cereal2)
#summary(cereal_m1)
Anova(m2)
#anova(cereal_base, cereal_saturated, test='Chi')
```

# Question F:

**Kellogg’s Apple Jacks (http://www.applejacks.com) is a cereal marketed toward children. For a serving size of 28 grams, its sugar content is 12 grams, fat content is 0.5 grams, and sodium content is 130 milligrams. Estimate the shelf probabilities for Apple Jacks.**

```{r}
# Apple Jack's content
serving <- 28
sugar <- 12
fat <- 0.5
sodium <- 130
# predict Apple Jack's shelf placement
predict(object = m, 
        data.frame(sugar = (sugar/serving - min(adj.d$sugar))/(max(adj.d$sugar)-min(adj.d$sugar)),
                   fat = (fat/serving - min(adj.d$fat))/(max(adj.d$fat)-min(adj.d$fat)),
                   sodium = (sodium/serving - min(adj.d$sodium))/(max(adj.d$sodium)-min(adj.d$sodium))),
        type = "probs")
```

Apple Jack will most likely be placed on the first shelf.

# Question G:

Construct a plot similar to Figure 3.3 where the estimated probability for a shelf is on the y-axis and the sugar content is on the x-axis. Use the mean overall fat and sodium content as the corresponding variable values in the model. Interpret the plot with respect to sugar content.




# Question H

Estimate odds ratios and calculate corresponding confidence intervals for each explanatory variable. Relate your interpretations back to the plots constructed for this exercise.

```{r}
exp(coef(m))
```


```{r}
# odd ratios
round(exp(coefficients(m)[,-1]), 2)

# confidence intervals
conf.beta <- confint(object = m, level = 0.95)
ci.OR.shelf2<-exp(conf.beta[2:4,1:2,1])
ci.OR.shelf3<-exp(conf.beta[2:4,1:2,2])
ci.OR.shelf4<-exp(conf.beta[2:4,1:2,3])
round(data.frame(low = ci.OR.shelf2[,1], up = ci.OR.shelf2[,2]), 2)
round(data.frame(low = ci.OR.shelf3[,1], up = ci.OR.shelf3[,2]), 2)
round(data.frame(low = ci.OR.shelf4[,1], up = ci.OR.shelf4[,2]), 2)
```



# Conclusion


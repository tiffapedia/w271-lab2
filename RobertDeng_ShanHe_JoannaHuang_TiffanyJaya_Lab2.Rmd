---
title: "Statistical Methods for Discrete Response, Time Series, and Panel Data (W271): Lab 2"
author: "Tiffany Jaya, Joanna Huang, Shan He, Robert Deng"
output: 
  pdf_document:
  toc: true
  number_sections: true
fontsize: 11pt
geometry: margin=1in
---

```{r}
# add packages
library(dplyr)
library(ggplot2)
library(knitr)
library(MASS)
library(nnet)
library(stargazer)
library(Hmisc)
library(car)
# prevent source code from running off the page
opts_chunk$set(tidy.opts=list(width.cutoff=70), tidy=TRUE)
# remove all objects from current workspace
rm(list = ls())
# set seed number to reproduce results
set.seed(1)
# load data
d <- read.csv("./dataset/cereal_dillons.csv", header=TRUE, sep=",")
```

# Introduction

We are under the impression that supermarkets place cereals strategically on shelves in order to increase sales. For this reason, a random sample of size 10 was taken from each of the four shelves at a Dillons grocery store in Manhattan, KS in order to answer our question: Does the cereal's nutritional composition have a significant effect on its shelving placement? 

TODO: methodology being employed, highlight the results

# EDA

In order for us to address this question, we first explored the dataset. The dataset contains 40 observations with 7 numerical attributes and no missing values:

- ID: Unique identifier for each cereal
- Shelf: Shelf number, which is numbered from the bottom (1) to the top (4)
- Cereal: Cereal product name with 38 distinct names
- size_g: Serving size with a range of 27-60 grams
- sugar_g: Sugar content with a range of 0-20 grams
- fat_g: Fat content with a range of 0-5 grams
- sodium_mg: Sodium content with a range of 0-330 milligrams

```{r}
# structure of data
str(d)
# summary of data
kable(summary(d[, 4:7]))
# list row with missing values
d[!complete.cases(d),]
```

TODO: handle anomalies?

## Univariate analysis

TODO: explore each variable -_-" boring

## Question A: Reformat the data

**The explanatory variables need to be re-formatted before proceeding further. First, divide each explanatory variable by its serving size to account for the different serving sizes among the cereals. Second, re-scale each variable to be
Symptoms Seizures Cardiac deficiency within 0 and 1.**

```{r}
# 1. adjust for different serving sizes 
adj.d <- data.frame(shelf = d$Shelf, 
                    sugar = d$sugar_g/d$size_g,
                    fat = d$fat_g/d$size_g, 
                    sodium = (d$sodium_mg/1000)/d$size_g)
# 2. normalize data to be within 0 and 1
normalize <- function(x) { (x-min(x))/(max(x)-min(x)) }
norm.d <- data.frame(shelf = adj.d$shelf, 
                     cereal = d$Cereal,
                     sugar = normalize(adj.d$sugar),
                     fat = normalize(adj.d$fat),
                     sodium = normalize(adj.d$sodium))
```

## Question B: Bivariate analysis

**Construct side-by-side box plots with dot plots overlaid for each of the explanatory variables.**

```{r fig.show='hold', fig.align='center', out.width='49%'}
# explanatory variable: sugar
boxplot(formula = sugar ~ shelf, data = norm.d, ylab = "Sugar", xlab = "Shelf", pars = list(outpch=NA))
stripchart(x = norm.d$sugar ~ norm.d$shelf, lwd = 2, col = "red", method = "jitter", vertical = TRUE, pch = 1, add = TRUE)

# explanatory variable: fat
boxplot(formula = fat ~ shelf, data = norm.d, ylab = "Fat", xlab = "Shelf", pars = list(outpch=NA))
stripchart(x = norm.d$fat ~ norm.d$shelf, lwd = 2, col = "red", method = "jitter", vertical = TRUE, pch = 1, add = TRUE)

# explanatory variable: sodium
boxplot(formula = sodium ~ shelf, data = norm.d, ylab = "Sodium", xlab = "Shelf", pars = list(outpch=NA))
stripchart(x = norm.d$sodium ~ norm.d$shelf, lwd = 2, col = "red", method = "jitter", vertical = TRUE, pch = 1, add = TRUE)
```

**Also, construct a parallel coordinates plot for the explanatory variables and the shelf number. Discuss if possible content differences exist among the shelves.**

```{r}
parcoord(x = norm.d, col = norm.d$shelf, lty = norm.d$shelf)  
legend("bottomleft", cex = 0.8, inset = .05, title = "Shelf Number", 
       legend = seq(1, 4), col = seq(1, 4), lty = seq(1, 4))
```

From this parallel coordinates plot, we see that:
1. Shelf 1 generally has higher sodium levels.
2. Shelf 2 generally has higher sugar levels.
3. Most cereals overlap in sugar and sodium levels but range in fat levels.

1: separation of high sugar and low sugar
some outliers

1: sugar 2, fat 4, sodium 1
2: sugar 1, fat 1, sodium 2
3: sugar 4, fat 2, sodium 3
4: sugar 3, fat 3, sodium 4


# Question C: 
 
**The response has values of 1, 2, 3, and 4. Under what setting would it be desirable to take into account ordinality. Do you think this occurs here?**

Since there are 4 shelf categories that a cereal box can be placed on, we will be using a multinomial regression model. Our goal is to model how the nutritional content affects a cereal’s corresponding probabilities each shelf category. Assuming that shelving has the potential of increasing or decreasing the likelihood that a product is purchased, an ordinal response model may be fitting. Since there is no given information on the ordering of the shelves, we will assume that customers have a tendency to look from the top to bottom, thus leading to the order of: Shelf 1 < Shelf 2 < Shelf 3 < Shelf 4.

```{r}
# apply ordinality 
norm.d$shelf <- factor(norm.d$shelf, levels=seq(1, 4), ordered=TRUE)
levels(norm.d$shelf)
```

```{r}
str(norm.d)
```


# Question D: Modeling

## Validating Assumptions

Multinomial logistic regression does not assume normality, linearity, or homoscedasticity. However, it does assume independence among the dependent variable choices meaning that the membership in one category is not related to membership in another category. Additionally, multinomial logistic regression assumes no complete separation.

Estimate a multinomial regression model with linear forms of the sugar, fat, and sodium variables. Perform LRTs to examine the importance of each explanatory variable.


```{r}
m <- multinom(formula = Shelf ~ sugar_g + fat_g + sodium_mg, data = cereal)
summary(m)
Anova(m)
```

# Question E: 

**Show that there are no significant interactions among the explanatory variables (including an interaction among all three variables).**



```{r}
#cor(cereal2[,c("sugar", "fat", "sodium")])
library(psych)
pairs.panels(cereal2[,c("sugar", "fat", "sodium")])
```

Looking at the correlation between the three explanatory variables, there does not appear to be any strong relationships as the correlation coefficients are all less than 0.5 in magnitude.

To look at whether we need interactions within our model, we can create a saturated model and run an Anova test to see if any interactions have significance.

```{r}
m0 <- multinom(formula=Shelf~1, data=cereal2)
m2 <- multinom(formula = Shelf ~ sugar*fat*sodium, data=cereal2)
#summary(cereal_m1)
Anova(m2)
#anova(cereal_base, cereal_saturated, test='Chi')
```

# Question F:

Kellogg’s Apple Jacks (http://www.applejacks.com) is a cereal marketed toward children. For a serving size of 28 grams, its sugar content is 12 grams, fat content is 0.5 grams, and sodium content is 130 milligrams. Estimate the shelf probabilities for Apple Jacks.



# Question G:

Construct a plot similar to Figure 3.3 where the estimated probability for a shelf is on the y-axis and the sugar content is on the x-axis. Use the mean overall fat and sodium content as the corresponding variable values in the model. Interpret the plot with respect to sugar content.




# Question H

Estimate odds ratios and calculate corresponding confidence intervals for each explanatory variable. Relate your interpretations back to the plots constructed for this exercise.

```{r}

```

# Invalidate 

Cereal manufacturers are willing to pay supermarkets more if their product was strategically placed on shelves where it can increase sales.

# Conclusion

